# ==============================================================================
# Pre-commit Configuration
# ==============================================================================
# Pre-commit hooks run automatically before each git commit to ensure code
# quality and catch issues early.
#
# Installation:
#   pip install pre-commit
#   pre-commit install          # Install hooks in your repo
#   pre-commit run --all-files  # Run manually on all files
#
# Hooks run in order. If any hook fails, the commit is aborted.
# Fix issues and try again, or use `git commit --no-verify` to skip (not recommended).
# ==============================================================================

repos:
  # ----------------------------------------------------------------------------
  # Terraform Formatting, Validation, and Documentation
  # ----------------------------------------------------------------------------
  - repo: https://github.com/antonbabenko/pre-commit-terraform
    rev: v1.88.0
    hooks:
      # Format all Terraform files
      - id: terraform_fmt
        name: Terraform Format
        description: Rewrites Terraform files to canonical format

      # Validate Terraform syntax
      - id: terraform_validate
        name: Terraform Validate
        description: Validates Terraform configuration files

      # Generate documentation from Terraform modules
      - id: terraform_docs
        name: Terraform Docs
        description: Auto-generates documentation from variables and outputs
        args:
          - --hook-config=--path-to-file=README.md
          - --hook-config=--add-to-existing-file=true
          - --hook-config=--create-file-if-not-exist=true

      # Run TFLint
      - id: terraform_tflint
        name: TFLint
        description: Lints Terraform files for errors and best practices
        args:
          - --args=--config=__GIT_WORKING_DIR__/.tflint.hcl

      # Run Trivy security scanner (replaces deprecated tfsec)
      # Skipped checks are configured in .trivyignore
      - id: terraform_trivy
        name: Trivy Security Scan
        description: Scans Terraform for security issues
        args:
          - --args=--ignorefile=__GIT_WORKING_DIR__/.trivyignore

      # Run Checkov security scanner
      - id: terraform_checkov
        name: Checkov Security Scan
        description: Scans for security and compliance misconfigurations
        args:
          - --args=--quiet
          - --args=--framework=terraform
          # Skip known/intentional findings (see comments below for rationale):
          - --args=--skip-check=CKV_AWS_144,CKV_AWS_145,CKV_AWS_260,CKV_AWS_382,CKV_AWS_23,CKV_AWS_130,CKV_AWS_135,CKV_AWS_337,CKV2_AWS_5,CKV2_AWS_12,CKV2_AWS_34,CKV2_AWS_11,CKV_SECRET_6
          #   CKV_AWS_144:  Cross-region replication — not required
          #   CKV_AWS_145:  SSM parameter KMS CMK — using default AWS-managed key
          #   CKV_AWS_260:  Unrestricted egress — intentional for publisher connectivity
          #   CKV_AWS_382:  Egress to 0.0.0.0/0 — intentional for publisher connectivity
          #   CKV_AWS_23:   Security group description — false positive
          #   CKV_AWS_130:  Public subnet assigns public IPs — NAT Gateway subnets only
          #   CKV_AWS_135:  EC2 EBS optimized — not supported on all instance types
          #   CKV_AWS_337:  SSM parameter KMS CMK — using default AWS-managed key for SecureString
          #   CKV2_AWS_5:   SG attached to ENI — false positive (attached to instances)
          #   CKV2_AWS_12:  Default VPC SG — not managed by this module
          #   CKV2_AWS_34:  SSM param encryption — CloudWatch config is not a secret
          #   CKV2_AWS_11:  VPC flow logging — optional hardening, not required
          #   CKV_SECRET_6: Base64 string — false positive on example comment

  # ----------------------------------------------------------------------------
  # General File Checks
  # ----------------------------------------------------------------------------
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      # Prevent large files from being committed
      - id: check-added-large-files
        args: ['--maxkb=1000']

      # Check for files that would conflict on case-insensitive filesystems
      - id: check-case-conflict

      # Check for merge conflict markers
      - id: check-merge-conflict

      # Ensure files end with a newline
      - id: end-of-file-fixer
        exclude: '\.tftpl$'

      # Remove trailing whitespace
      - id: trailing-whitespace
        exclude: '\.tftpl$'

      # Check YAML syntax
      - id: check-yaml
        args: ['--unsafe']  # Allow custom tags

      # Check JSON syntax
      - id: check-json

      # Detect AWS credentials
      - id: detect-aws-credentials
        args: ['--allow-missing-credentials']

      # Detect private keys
      - id: detect-private-key

  # ----------------------------------------------------------------------------
  # Secrets Detection
  # ----------------------------------------------------------------------------
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.18.2
    hooks:
      - id: gitleaks
        name: Detect Secrets
        description: Scans for hardcoded secrets and credentials

# ==============================================================================
# Configuration
# ==============================================================================
# Exclude certain files/directories from all hooks
exclude: |
  (?x)^(
    \.terraform/.*|
    \.terraform\.lock\.hcl|
    terraform/\.terraform/.*|
    terraform/\.terraform\.lock\.hcl
  )$

# Run hooks in parallel for speed
ci:
  autofix_prs: false
  autoupdate_schedule: monthly
